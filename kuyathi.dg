response = Map();
// 1. GET VISITOR INFO
// We try to get the name. If they are anonymous, we call them "Friend" (Nanba/Nanbi)
visitor_name = visitor.get("name");
if(visitor_name == null || visitor_name == "")
{
	display_name = "Friend";
}
else
{
	display_name = visitor_name;
}
// 2. CONSTRUCT GREETING
greeting_text = "Vanakkam " + display_name + "! üôè I am Kuyathi. I mold tradition for your modern home.";
sub_text = "How can I help you today?";
// 3. DEFINE OPTIONS
response.put("action","reply");
response.put("replies",{greeting_text,sub_text});
// 4. MAIN MENU INPUT
// Using a 'select' input type for clickable buttons
response.put("input",{"type":"select","options":{"Shop Collections","Track Order","Pottery Traditions","Book Workshop"}});
return response;



response = Map();
msg = message.get("text");
// Default fallback
response.put("action","reply");
// Add this inside your Message Handler (at the start)
if(msg != null && msg != "")
{
	if(msg.equalsIgnoreCase("Ask another question") || msg.equalsIgnoreCase("Back to Main Menu"))
	{
		if(msg.equalsIgnoreCase("Back to Main Menu"))
		{
			response.put("action","reply");
			response.put("replies",{"What would you like to do next?"});
			response.put("input",{"type":"select","options":{"Shop Collections","Track Order","Pottery Traditions","Book Workshop"}});
			return response;
		}
		else
		{
			// Reset the AI flow (Ask another question)
			response.put("action","context");
			response.put("context_id","edu_flow");
			// Single line definition to avoid syntax errors
			question = {"name":"user_question","replies":{"I am listening. What else would you like to know?"}};
			response.put("questions",{question});
			return response;
		}
	}
	// --- 1. WORKSHOP ---
	if(msg.containsIgnoreCase("Workshop"))
	{
		response.put("action","context");
		response.put("context_id","workshop_flow");
		question = {"name":"class_type","replies":{"Choose a class:"},"input":{"type":"select","options":{"Beginner Wheel","Kids Clay Day"}}};
		response.put("questions",{question});
	}
	// --- 2. SHOPPING ---
	else if(msg.containsIgnoreCase("Shop") || msg.containsIgnoreCase("Buy") || msg.containsIgnoreCase("Catalog"))
	{
		response.put("action","context");
		response.put("context_id","shop_flow");
		question = {"name":"category","replies":{"Welcome! Which collection?"},"input":{"type":"select","options":{"Terracotta Cookware","Modern Decor","Garden Pots"}}};
		response.put("questions",{question});
	}
	// --- 3. TRACKING (THE FIX) ---
	else if(msg.containsIgnoreCase("Track") || msg.containsIgnoreCase("Order") || msg.containsIgnoreCase("Status"))
	{
		// CHECK EMAIL IMMEDIATELY
		user_email = visitor.get("email");
		// CASE A: We know the email -> Auto-Fetch HERE
		if(user_email != null && user_email != "")
		{
			// Call API directly in Message Handler
			api_url = "https://zobot.edventuretech.in/api/chatbot/orders/user/" + user_email;
			try 
			{
				order_list = invokeurl
				[
					url :api_url
					type :GET
					parameters:{"user_id":user_email}
				];
				// Parse logic (Same as before)
				if(order_list != null && order_list.size() > 0)
				{
					replies_collection = Collection();
					replies_collection.insert({"text":"Welcome back! I found these orders for " + user_email + ":"});
					for each  order in order_list
					{
						oid = order.get("id");
						status = order.get("status");
						total = order.get("total_amount");
						items_list = order.get("order_items");
						product_name = "Assorted Items";
						product_img = "https://via.placeholder.com/150";
						if(items_list.size() > 0)
						{
							first_item = items_list.get(0);
							product_details = first_item.get("product");
							product_name = product_details.get("name");
							raw_img = product_details.get("image_url");
							if(raw_img != null && raw_img != "")
							{
								product_img = raw_img;
							}
						}
						replies_collection.insert({"text":"Order #" + oid + " | Status: " + status + "\nItem: " + product_name,"image":product_img});
					}
					// Action is REPLY because we are done
					response.put("action","reply");
					response.put("replies",replies_collection);
				}
				else
				{
					response.put("action","reply");
					response.put("replies",{"I checked my records for " + user_email + " but found no active orders."});
				}
			}
			catch (e)
			{
				response.put("action","reply");
				response.put("replies",{"Error connecting to order database."});
			}
		}
		// CASE B: We DON'T know the email -> Switch to Context
		else
		{
			response.put("action","context");
			response.put("context_id","track_flow");
			// WE MUST PROVIDE A QUESTION HERE
			question = {"name":"manual_email","replies":{"I need your email address to find your order history. Please type it below."}};
			response.put("questions",{question});
		}
	}
	// --- 4. TRADITION ---
	else if(msg.containsIgnoreCase("Tradition") || msg.containsIgnoreCase("Process") || msg.containsIgnoreCase("Learn") || msg.containsIgnoreCase("Ask another question"))
	{
		response.put("action","context");
		response.put("context_id","edu_flow");
		// CRITICAL CHANGE: 
		// We removed the "input type: select" (Buttons). 
		// By NOT defining an input type, the bot accepts Free Text.
		// The name "user_question" MUST match what your Context Handler is looking for.
		greeting_msg = "Vanakkam! I am Kuyathi. üè∫";
		prompt_msg = "I can tell you about our clay sourcing, the firing process, or the history of potters. What do you wish to know?";
		// If this is a loop (user clicked "Ask another question"), we give a shorter prompt
		if(msg.equalsIgnoreCase("Ask another question"))
		{
			greeting_msg = "I am listening.";
			prompt_msg = "What else are you curious about?";
		}
		question = {"name":"user_question","replies":{greeting_msg,prompt_msg}};
		response.put("questions",{question});
	}
	// --- 5. FALLBACK ---
	else
	{
		response.put("replies",{"I didn't catch that. Select an option:"});
		response.put("input",{"type":"select","options":{"Shop Collections","Track Order","Pottery Traditions"}});
	}
}
return response;





response = Map();
response.put("action","context");
response.put("context_id",context_id);
// Keep user in current context until "end"
// ============================================================
// CONTEXT: SHOPPING FLOW
// ============================================================
if(context_id.equals("shop_flow"))
{
	// Step 1: Check if Category is selected
	if(answers.containsKey("category"))
	{
		category = answers.get("category").get("text");
		// Step 2: Show Products based on category
		// If they haven't selected a specific product yet
		if(!answers.containsKey("product_selection"))
		{
			// Prepare product list based on category
			replies_list = Collection();
			options_list = Collection();
			if(category.containsIgnoreCase("Cookware"))
			{
				replies_list.insert({"text":"Here are our best-sellers for healthy cooking:"});
				replies_list.insert({"text":"Clay Curd Pot (1L) - $15","image":"https://via.placeholder.com/150?text=Curd+Pot"});
				replies_list.insert({"text":"Biryani Clay Pot - $25","image":"https://via.placeholder.com/150?text=Biryani+Pot"});
				options_list.add("Clay Curd Pot");
				options_list.add("Biryani Pot");
			}
			else if(category.containsIgnoreCase("Decor"))
			{
				replies_list.insert({"text":"Modern aesthetics with earthy roots:"});
				replies_list.insert({"text":"Tall Vase - $40","image":"https://via.placeholder.com/150?text=Vase"});
				options_list.add("Tall Vase");
			}
			else
			{
				// Fallback for Garden or others
				replies_list.insert({"text":"Perfect for your green friends:"});
				replies_list.insert({"text":"Hanging Planter - $20","image":"https://via.placeholder.com/150?text=Planter"});
				options_list.add("Hanging Planter");
			}
			options_list.add("Back to Menu");
			question = {"name":"product_selection","replies":replies_list,"input":{"type":"select","options":options_list}};
			response.put("questions",{question});
		}
		else
		{
			// Step 3: Handle Purchase
			product = answers.get("product_selection").get("text");
			if(product.equals("Back to Menu"))
			{
				response.put("action","end");
				response.put("replies",{"No problem! Let me know if you need anything else."});
				return response;
			}
			// Ask for email if not provided
			if(!answers.containsKey("email"))
			{
				question = {"name":"email","replies":{"Great choice! The " + product + " is beautiful. Please share your email to send the invoice link."},"input":{"type":"email"}};
				response.put("questions",{question});
			}
			else
			{
				// Send Email Logic
				email = answers.get("email").get("text");
				// NOTE: Replace 'zoho.adminuserid' with your verified admin email if needed
				/* sendmail
                [
                    from: zoho.adminuserid
                    to: email
                    subject: "Order Inquiry: " + product
                    message: "Hi! Thanks for choosing Kuyathi. Click here to pay: [Link]"
                ]
                */
				response.put("action","end");
				response.put("replies",{"Thank you! I have sent the details to " + email + ". Happy clay living!"});
			}
		}
	}
}
// ============================================================
// CONTEXT: TRADITIONS (EDUCATION)
// ============================================================
// ============================================================
// CONTEXT: AI-POWERED POTTERY TRADITION (GEMINI)
// ============================================================
else if(context_id.equals("edu_flow"))
{
	// 1. GET USER QUESTION
	// We check if the user has typed a question in this context
	if(!answers.containsKey("user_question"))
	{
		question = {"name":"user_question","replies":{"I am Kuyathi, guardian of the kiln. üè∫","Ask me anything about pottery history, clay science, or our traditions."}};
		// Allow free text input (no buttons)
		response.put("questions",{question});
	}
	else
	{
		user_query = answers.get("user_question").get("text");
		// 2. CONFIGURE GEMINI API
		// Replace with your actual Google AI Studio API Key
		api_key = "AIzaSyAugIc0rqrK00TBo9lpA7A6hGq3s77wMmE";
		// Using Gemini 1.5 Flash (Fast & Cost-effective)
		endpoint = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=" + api_key;
		// 3. DEFINE THE PERSONA (System Prompt)
		system_instruction = "You are Kuyathi, a wise female potter from Tamil Nadu. " + "You speak with warmth and respect (use 'Vanakkam'). " + "You are an expert in terracotta, glazing, and clay traditions. " + "Keep your answers concise (under 3 sentences) suitable for a chat window. " + "If the question is not about pottery, politely guide them back to clay topics.";
		// 4. CONSTRUCT JSON PAYLOAD
		// Gemini API expects a specific nested structure
		payload_map = Map();
		// Content (User Query)
		contents_list = List();
		content_part = Map();
		parts_list = List();
		parts_list.add({"text":user_query});
		content_part.put("parts",parts_list);
		contents_list.add(content_part);
		payload_map.put("contents",contents_list);
		// System Instruction (The Persona)
		sys_map = Map();
		sys_parts = List();
		sys_parts.add({"text":system_instruction});
		sys_map.put("parts",sys_parts);
		payload_map.put("system_instruction",sys_map);
		try 
		{
			// 5. CALL GEMINI API
			api_response = invokeurl
			[
				url :endpoint
				type :POST
				parameters:payload_map.toString()
				headers:{"Content-Type":"application/json"}
			];
			// 6. PARSE RESPONSE
			// Path: candidates[0] -> content -> parts[0] -> text
			candidates = api_response.get("candidates");
			if(candidates != null && candidates.size() > 0)
			{
				bot_answer = candidates.get(0).get("content").get("parts").get(0).get("text");
				// 7. REPLY AND LOOP
				// We send the answer and ask if they have more questions
				// To create a loop, we must clear the previous answer key so SalesIQ asks again
				// *Note: In standard SalesIQ scripts, we return 'reply'. 
				// To Loop, we usually provide a button to continue.*
				response.put("action","reply");
				response.put("replies",{bot_answer});
				// Add a small footer menu to keep them engaged
				response.put("input",{"type":"select","options":{"Ask another question","Back to Main Menu"}});
			}
			else
			{
				// Fallback if AI returns empty
				response.put("action","reply");
				response.put("replies",{"The kiln smoke clouded my vision. I couldn't process that thought. Try asking differently?"});
			}
		}
		catch (e)
		{
			response.put("action","reply");
			response.put("replies",{"My connection to the wisdom spirits (API) is broken. Error: " + e});
		}
	}
}
// ============================================================
// CONTEXT: TRACKING
// ============================================================
// ============================================================
// CONTEXT: AUTO-FETCH TRACKING FLOW (EXTERNAL DB)
// ============================================================
else if(context_id.equals("track_flow"))
{
    // --- STEP 1: RESOLVE EMAIL ---
    user_email = visitor.get("email");
    if((user_email == null || user_email == "") && !answers.containsKey("manual_email"))
    {
        question = {"name": "manual_email", "replies": {"Please enter your email address to find your orders."}};
        response.put("questions", {question});
        return response; 
    }
    
    target_email = user_email;
    if(answers.containsKey("manual_email")) { target_email = answers.get("manual_email").get("text"); }

    // --- STEP 2: FETCH & DISPLAY OPTIONS (If order not yet selected) ---
    if(!answers.containsKey("selected_order_id"))
    {
        api_url = "https://zobot.edventuretech.in/api/chatbot/orders/user/" + target_email; // Replace with your API
        
        try 
        {
            order_list = invokeurl
            [
                url : api_url
                type : GET
                parameters : {"user_id": target_email}
            ];
            
            if(order_list != null && order_list.size() > 0)
            {
                options_list = Collection();
                
                // Create a button for each order
                for each order in order_list
                {
                    oid = order.get("id");
                    // Format: "#101 - Pending"
                    // We use this string as the button label
                    btn_label = "#" + oid + " - " + order.get("status");
                    options_list.add(btn_label);
                }
                
                question = {
                    "name": "selected_order_id",
                    "replies": {"I found " + order_list.size() + " orders. Which one would you like to manage?"},
                    "input": {
                        "type": "select",
                        "options": options_list
                    }
                };
                response.put("questions", {question});
            }
            else
            {
                response.put("action", "end");
                response.put("replies", {"No active orders found for " + target_email});
            }
        }
        catch(e)
        {
            response.put("action", "end");
            response.put("replies", {"System Error: Unable to fetch order list."});
        }
    }
    // --- STEP 3: SHOW DETAILS & ACTIONS (Once Order is Selected) ---
    else if(!answers.containsKey("order_action"))
    {
        // User clicked something like "#101 - Pending"
        selection_str = answers.get("selected_order_id").get("text");
        
        // Extract the ID (Assumes format starts with #)
        // We split by space to get just the ID part if needed, or send the whole string
        
        question = {
            "name": "order_action",
            "replies": {
                "You selected " + selection_str,
                "Here are the details. What would you like to do?"
            },
            "input": {
                "type": "select",
                "options": {"Download Invoice", "Cancel Order", "Go Back"}
            }
        };
        response.put("questions", {question});
    }
    // --- STEP 4: EXECUTE ACTION ---
    else
    {
        action = answers.get("order_action").get("text");
        raw_selection = answers.get("selected_order_id").get("text");
        
        // Simple extraction to get ID "101" from string "#101 - Pending"
        // Adjust logic based on your actual string format
        order_id = raw_selection.getPrefix(" -").remove("#"); 
        
        if(action.equals("Download Invoice"))
        {
            // Generate link (Simulated)
            invoice_link = "https://zobot.edventuretech.in/api/chatbot/orders/" + order_id + "/invoice";
            
            response.put("action", "end");
            response.put("replies", {
                "Here is your invoice for Order #" + order_id,
                {"text": "Click to Download", "url": invoice_link}
            });
        }
        else if(action.equals("Cancel Order"))
        {
            // Call API to Cancel
            cancel_url = "https://zobot.edventuretech.in/api/chatbot/orders/" + order_id + "/cancel";
            
            try
            {
                cancel_response = invokeurl
                [
                    url : cancel_url
                    type : POST
                ];
                
                response.put("action", "end");
                response.put("replies", {"Order #" + order_id + " has been successfully cancelled. Refund will be processed in 3-5 days."});
            }
            catch(e)
            {
                response.put("action", "end");
                response.put("replies", {"I couldn't cancel the order. It might already be shipped."});
            }
        }
        else
        {
            response.put("action", "end");
            response.put("replies", {"Let me know if you need anything else!"});
        }
    }
}
// ============================================================
// CONTEXT: WORKSHOPS
// ============================================================
else if(context_id.equals("workshop_flow"))
{
	// 1. CHECK CLASS TYPE (Usually selected in Message Handler)
	if(answers.containsKey("class_type"))
	{
		class_name = answers.get("class_type").get("text");
		// 2. CHECK DATE (Using Calendar Card)
		if(!answers.containsKey("workshop_date"))
		{
			question = {"name":"workshop_date","replies":{"You have chosen the " + class_name + "! üè∫","Please select a date for your session."},"input":{"type":"calendar","placeholder":"Select a Date"}};
			response.put("questions",{question});
		}
		else
		{
			selected_date = answers.get("workshop_date").get("text");
			// 3. CHECK TIME (Using Select Card as Time Slots)
			if(!answers.containsKey("workshop_time"))
			{
				// Define available slots (Static list for now)
				// If you want these dynamic, you'd call your API here first to get available slots for 'selected_date'
				available_slots = {"10:00 AM","02:00 PM","05:00 PM"};
				question = {"name":"workshop_time","replies":{"Great! We have the following slots available on " + selected_date + "."},"input":{"type":"select","options":available_slots}};
				response.put("questions",{question});
			}
			else
			{
				selected_time = answers.get("workshop_time").get("text");
				// 4. CHECK USER EMAIL (For booking confirmation)
				// We check if we already have it from the visitor session or previous steps
				user_email = visitor.get("email");
				if((user_email == null || user_email == "") && !answers.containsKey("contact_email"))
				{
					question = {"name":"contact_email","replies":{"Almost done! Where should I send the booking confirmation?"},"input":{"type":"email"}};
					response.put("questions",{question});
				}
				else
				{
					// Resolve final email
					final_email = user_email;
					if(answers.containsKey("contact_email"))
					{
						final_email = answers.get("contact_email").get("text");
					}
					// 5. SEND TO BACKEND API
					api_url = "https://your-api-url.com/book-workshop";
					// Construct the Payload
					booking_data = Map();
					booking_data.put("workshop",class_name);
					booking_data.put("date",selected_date);
					booking_data.put("time",selected_time);
					booking_data.put("email",final_email);
					try 
					{
						// FIX: Comments removed from inside the brackets
						// Passing the Map directly sends it as Form Data (x-www-form-urlencoded)
						api_response = invokeurl
						[
							url :api_url
							type :POST
							parameters:booking_data
						];
						// 6. FINAL SUCCESS MESSAGE
						response.put("action","end");
						response.put("replies",{"Booking Confirmed! ‚úÖ","I have reserved a spot for " + class_name + " on " + selected_date + " at " + selected_time + ".","A confirmation email has been sent to " + final_email});
					}
					catch (e)
					{
						response.put("action","end");
						response.put("replies",{"I couldn't reach the reservation book (Server Error). Please try again later."});
					}
				}
			}
		}
	}
}
return response;





